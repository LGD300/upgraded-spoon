<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ScheduleMaster — Responsive Calendar & Notification System (School Prototype)</title>

<!--
ScheduleMaster - Single-file implementation (updated)
Features added:
- Role selector (Teacher / Student) in header (saved to localStorage)
- Teacher: add/edit/delete events. Student: read-only view.
- Dark / Light theme toggle (saved to localStorage)
- Events store 'createdBy' attribute
- No sound for notifications; toast slide-in only
- Refactored JS structure, comments, and role-based UI behavior
-->

<style>
  /* --- Theme variables (light defaults) --- */
  :root{
    --primary:#4361ee; /* Professional blue */
    --secondary:#7209b7; /* Accent purple */
    --success:#4cc9f0; /* Notification blue */
    --warning:#f72585; /* Alert pink */
    --bg:#f5f7fb;
    --card:#ffffff;
    --muted:#6b7280;
    --text:#0f1724;
    --accent-contrast:#ffffff;
    --shadow: 0 6px 18px rgba(15,23,42,0.06);
    --radius:12px;
    --font-stack:"Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }

  /* --- Dark theme overrides (added/removed via body.classList) --- */
  body.dark {
    --bg:#0b1220;
    --card:#0f1724;
    --muted:#9aa4bb;
    --text:#e6eef8;
    --shadow: 0 8px 26px rgba(0,0,0,0.6);
  }

  /* Mobile-first layout */
  html,body{height:100%;}
  body{
    margin:0;
    font-family:var(--font-stack);
    background:linear-gradient(180deg, var(--bg), rgba(0,0,0,0));
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    line-height:1.35;
    padding:16px;
    transition: background .18s ease, color .18s ease;
  }

  .app{
    max-width:1100px;
    margin:0 auto;
    display:flex;
    flex-direction:column;
    gap:16px;
  }

  header.app-header{
    display:flex;
    align-items:center;
    gap:12px;
    justify-content:space-between;
  }

  .brand{
    display:flex;
    gap:12px;
    align-items:center;
  }
  .logo{
    width:44px;height:44px;border-radius:10px;
    background:linear-gradient(135deg,var(--primary),var(--secondary));
    display:flex;align-items:center;justify-content:center;color:var(--accent-contrast);
    font-weight:700;box-shadow:var(--shadow);
  }
  .brand h1{font-size:18px;margin:0}
  .brand p{margin:0;font-size:12px;color:var(--muted)}

  .header-actions{display:flex;gap:8px;align-items:center;}
  .btn{
    display:inline-flex;gap:8px;align-items:center;padding:8px 12px;border-radius:10px;
    background:var(--card);border:1px solid rgba(15,23,42,0.06);cursor:pointer;font-weight:600;
    box-shadow:var(--shadow);color:var(--text);
  }
  .btn.primary{background:var(--primary);color:var(--accent-contrast);border:none}
  .btn.ghost{background:transparent;border:1px solid rgba(15,23,42,0.06)}

  /* Role select & theme toggle */
  .role-select{padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:transparent;color:var(--text)}
  .theme-toggle{display:inline-flex;align-items:center;gap:8px;padding:8px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);background:transparent;cursor:pointer}

  /* Main layout: calendar + sidebar form/list */
  .main{
    display:grid;
    grid-template-columns:1fr;
    gap:16px;
  }

  .card{
    background:var(--card);padding:14px;border-radius:var(--radius);box-shadow:var(--shadow);
    transition: background .18s ease, color .18s ease;
  }

  /* Calendar header controls */
  .calendar-top{
    display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:12px;
  }
  .month-title{font-size:18px;font-weight:700;display:flex;gap:12px;align-items:center}
  .nav-controls{display:flex;gap:8px;align-items:center}

  /* Weekday labels */
  .weekday-row{
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:6px;
    color:var(--muted);
    font-size:13px;
    margin-bottom:8px;
    text-align:center;
  }

  /* Calendar grid */
  .calendar-grid{
    display:grid;
    grid-template-columns:repeat(7,1fr);
    gap:8px;
  }
  .day {
    min-height:80px;
    border-radius:10px;
    padding:8px;
    position:relative;
    background:linear-gradient(180deg,transparent,transparent);
    cursor:pointer;
    display:flex;flex-direction:column;justify-content:flex-start;
    transition:transform .12s ease, box-shadow .12s ease;
    border:1px solid rgba(15,23,42,0.03);
    color:var(--text);
  }
  .day:hover{transform:translateY(-4px);box-shadow:0 8px 24px rgba(15,23,42,0.06)}
  .muted-day{color:rgba(15,23,42,0.28);background:transparent;opacity:.6}
  .today{
    outline:3px solid rgba(67,97,238,0.12);
    box-shadow:inset 0 -3px 0 rgba(67,97,238,0.05);
  }
  .date-num{font-weight:700;font-size:14px;display:flex;align-items:center;gap:8px}
  .markers{margin-top:6px;display:flex;gap:6px;flex-wrap:wrap}
  .event-badge{
    background:linear-gradient(90deg,var(--primary),var(--secondary));
    color:var(--accent-contrast);padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700;
    box-shadow:0 6px 12px rgba(67,97,238,0.08)
  }
  .event-count{
    margin-left:auto;background:rgba(15,23,42,0.06);padding:2px 8px;border-radius:999px;font-size:12px;
    color:var(--muted)
  }

  /* Selected day highlighting */
  .day.selected{background:linear-gradient(180deg,rgba(67,97,238,0.03),transparent);border-color:rgba(67,97,238,0.12)}

  /* Sidebar form & upcoming events */
  .sidebar{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
  }

  form.event-form{display:flex;flex-direction:column;gap:8px;}
  .field{display:flex;flex-direction:column;gap:6px}
  label{font-size:13px;color:var(--muted)}
  input[type="text"], input[type="date"], input[type="time"], textarea, select{
    padding:10px;border-radius:8px;border:1px solid rgba(15,23,42,0.06);font-size:14px;background:transparent;color:var(--text);
  }
  textarea{min-height:84px;resize:vertical;padding-top:10px}
  .row{display:flex;gap:8px}
  .row .field{flex:1}

  .event-list{display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto;padding-right:6px}
  .event-item{display:flex;gap:8px;align-items:flex-start;padding:8px;border-radius:10px;border:1px solid rgba(15,23,42,0.03);background:linear-gradient(180deg,transparent,transparent)}
  .event-meta{display:flex;flex-direction:column;gap:6px}
  .event-time{font-weight:700;color:var(--primary)}
  .event-title{font-weight:700}
  .event-desc{color:var(--muted);font-size:13px}

  .tag {
    font-size:11px;padding:4px 8px;border-radius:999px;background:rgba(15,23,42,0.04);color:var(--muted);
    margin-left:6px;
  }

  /* Notification panel (slide-in) */
  .notifications{
    position:fixed;
    z-index:1200;
    right:16px;
    bottom:16px;
    display:flex;
    flex-direction:column;
    gap:10px;
    max-width:320px;
    pointer-events:none;
  }
  .toast{
    pointer-events:auto;
    background:linear-gradient(180deg,var(--card),#fff);
    border-radius:12px;padding:12px;border:1px solid rgba(15,23,42,0.06);
    box-shadow:0 12px 30px rgba(15,23,42,0.12);
    transform:translateY(20px) scale(.98);
    opacity:0;transition:transform .25s cubic-bezier(.2,.9,.2,1),opacity .25s;
    display:flex;gap:10px;align-items:flex-start;
    color:var(--text);
  }
  .toast.show{transform:none;opacity:1}
  .toast .left{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,var(--primary),var(--secondary));display:flex;align-items:center;justify-content:center;color:white;font-weight:700}
  .toast .right{flex:1}
  .toast .close{cursor:pointer;border-radius:8px;border:none;background:transparent;padding:6px;color:var(--muted)}
  .toast .title{font-weight:800}
  .toast small{color:var(--muted)}

  /* Responsive: tablet and desktop */
  @media(min-width:576px){
    .main{grid-template-columns: 1fr 360px;}
    .sidebar{grid-template-columns:1fr}
    .calendar-grid .day{min-height:96px}
  }
  @media(min-width:992px){
    body{padding:28px}
    .brand h1{font-size:20px}
    .calendar-grid .day{min-height:120px}
    .notifications{right:28px;bottom:28px;max-width:380px}
  }

  /* tiny utility */
  .muted{color:var(--muted);font-size:13px}
  .flex{display:flex;align-items:center;gap:8px}
  .small{font-size:13px}
  .hidden{display:none}
  .form-actions{display:flex;gap:8px;justify-content:flex-end}
  .pill{padding:6px 10px;border-radius:999px;background:rgba(15,23,42,0.03);font-weight:700;font-size:13px}
  .disabled { opacity: .5; pointer-events: none; filter: grayscale(.1); }
</style>
</head>
<body>
  <div class="app" id="app">
    <header class="app-header">
      <div class="brand">
        <div class="logo">SM</div>
        <div>
          <h1>ScheduleMaster</h1>
          <p>School calendar • Teacher & Student modes</p>
        </div>
      </div>

      <div class="header-actions">
        <!-- Role selector (always visible) -->
        <select id="roleSelect" class="role-select" aria-label="Choose role">
          <option value="student">Student</option>
          <option value="teacher">Teacher</option>
        </select>

        <!-- Theme toggle -->
        <button id="themeToggle" class="theme-toggle" title="Toggle theme">🌙</button>

        <div class="pill small muted">Mobile • Tablet • Desktop</div>
        <button class="btn primary" id="todayBtn" title="Go to today">Today</button>
      </div>
    </header>

    <main class="main">
      <!-- Calendar Card -->
      <section class="card" aria-labelledby="calendarTitle">
        <div class="calendar-top">
          <div class="month-title" id="calendarTitle">
            <div id="monthLabel"></div>
            <div class="muted small" id="yearLabel"></div>
          </div>
          <div class="nav-controls">
            <button class="btn ghost" id="prevMonthBtn" title="Previous month">&larr;</button>
            <button class="btn ghost" id="nextMonthBtn" title="Next month">&rarr;</button>
          </div>
        </div>

        <div class="weekday-row" id="weekdayRow" aria-hidden="true">
          <!-- Weekday labels filled by JS -->
        </div>

        <div class="calendar-grid" id="calendarGrid" role="grid">
          <!-- Days injected by JS -->
        </div>
      </section>

      <!-- Sidebar: Event form + upcoming events -->
      <aside class="sidebar">
        <div class="card" id="formCard">
          <h3 style="margin:0 0 8px 0">Add / Edit Event</h3>

          <form id="eventForm" class="event-form" autocomplete="off">
            <input type="hidden" id="eventId" />
            <div class="field">
              <label for="title">Event title *</label>
              <input id="title" type="text" placeholder="Meeting with team" required />
            </div>

            <div class="row">
              <div class="field">
                <label for="date">Date *</label>
                <input id="date" type="date" required />
              </div>
              <div class="field">
                <label for="startTime">Start *</label>
                <input id="startTime" type="time" required />
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label for="endTime">End *</label>
                <input id="endTime" type="time" required />
              </div>
              <div class="field">
                <label for="reminder">Reminder</label>
                <select id="reminder">
                  <option value="10" selected>10 minutes before</option>
                  <option value="5">5 minutes before</option>
                  <option value="15">15 minutes before</option>
                  <option value="0">At start time</option>
                </select>
              </div>
            </div>

            <div class="field">
              <label for="description">Description</label>
              <textarea id="description" placeholder="Optional details..."></textarea>
            </div>

            <div class="form-actions" id="formActions">
              <button type="button" class="btn" id="clearBtn">Clear</button>
              <button type="submit" class="btn primary" id="saveBtn">Save Event</button>
            </div>
            <p class="muted small" style="margin:6px 0 0 0">* Required fields — times are local and displayed in 12-hour format.</p>
            <p id="roleNotice" class="muted small" style="margin:6px 0 0 0"></p>
          </form>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px 0">Upcoming Events</h3>
          <div class="event-list" id="upcomingList" aria-live="polite">
            <!-- upcoming events injected -->
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- Notification container -->
  <div class="notifications" id="notifications" aria-live="assertive" aria-atomic="true"></div>

<script>
/* ===========================
   ScheduleMaster (School) JS
   - Role selector (teacher/student)
   - Dark/light theme toggle
   - Event CRUD with createdBy
   - Notifications (silent toast)
   - localStorage persistence
   =========================== */

/* -----------------------
   Storage keys & helpers
   ----------------------- */
const STORAGE_KEY = 'schedulemaster_events_v1';
const NOTIFIED_KEY = 'schedulemaster_notified_v1';
const ROLE_KEY = 'schedulemaster_role_v1';
const THEME_KEY = 'schedulemaster_theme_v1'; // 'light' or 'dark'

function loadEvents(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; }catch(e){ console.error('Failed to parse events', e); return []; } }
function saveEvents(events){ localStorage.setItem(STORAGE_KEY, JSON.stringify(events)); }

function loadNotified(){ try{ const raw = localStorage.getItem(NOTIFIED_KEY); return raw ? JSON.parse(raw) : []; }catch(e){ return []; } }
function saveNotified(arr){ localStorage.setItem(NOTIFIED_KEY, JSON.stringify(arr || [])); }

function loadRole(){ return localStorage.getItem(ROLE_KEY) || 'student'; }
function saveRole(role){ localStorage.setItem(ROLE_KEY, role); }

function loadTheme(){ return localStorage.getItem(THEME_KEY) || 'light'; }
function saveTheme(t){ localStorage.setItem(THEME_KEY, t); }

/* -----------------------
   Date helpers
   ----------------------- */
const WEEKDAYS = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
function pad(n){ return n.toString().padStart(2,'0'); }
function ymdToDate(ymd, time24){
  const [y,m,d] = String(ymd).split('-').map(Number);
  if(!time24) return new Date(y,m-1,d);
  const [hh,mm] = String(time24).split(':').map(Number);
  return new Date(y,m-1,d,hh,mm,0,0);
}
function format12(date){
  let h = date.getHours();
  const m = date.getMinutes();
  const am = h < 12 ? 'AM' : 'PM';
  h = h % 12; if(h === 0) h = 12;
  return `${h}:${pad(m)} ${am}`;
}
function ymdFromDate(date){ return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())}`; }
function startOfMonth(date){ return new Date(date.getFullYear(), date.getMonth(), 1); }
function endOfMonth(date){ return new Date(date.getFullYear(), date.getMonth()+1, 0); }

/* -----------------------
   App State & DOM refs
   ----------------------- */
const state = {
  currentMonth: new Date(),
  events: loadEvents(),
  notified: loadNotified(),
  selectedDate: null,
  role: loadRole(), // 'teacher' or 'student'
  theme: loadTheme() // 'light' or 'dark'
};

const refs = {
  monthLabel: document.getElementById('monthLabel'),
  yearLabel: document.getElementById('yearLabel'),
  calendarGrid: document.getElementById('calendarGrid'),
  weekdayRow: document.getElementById('weekdayRow'),
  todayBtn: document.getElementById('todayBtn'),
  prevMonthBtn: document.getElementById('prevMonthBtn'),
  nextMonthBtn: document.getElementById('nextMonthBtn'),
  roleSelect: document.getElementById('roleSelect'),
  themeToggle: document.getElementById('themeToggle'),
  eventForm: document.getElementById('eventForm'),
  titleInput: document.getElementById('title'),
  dateInput: document.getElementById('date'),
  startTimeInput: document.getElementById('startTime'),
  endTimeInput: document.getElementById('endTime'),
  descInput: document.getElementById('description'),
  reminderSelect: document.getElementById('reminder'),
  eventIdInput: document.getElementById('eventId'),
  clearBtn: document.getElementById('clearBtn'),
  upcomingList: document.getElementById('upcomingList'),
  notificationsContainer: document.getElementById('notifications'),
  formActions: document.getElementById('formActions'),
  roleNotice: document.getElementById('roleNotice'),
  formCard: document.getElementById('formCard')
};

/* -----------------------
   Initialization: theme + role UI
   ----------------------- */
function applyTheme(theme){
  if(theme === 'dark') document.body.classList.add('dark');
  else document.body.classList.remove('dark');
  refs.themeToggle.textContent = theme === 'dark' ? '☀️' : '🌙';
  state.theme = theme;
  saveTheme(theme);
}
function applyRole(role){
  state.role = role;
  saveRole(role);
  refs.roleSelect.value = role;
  // If student => disable inputs & actions; teacher => enable
  const isStudent = (role === 'student');
  // disable inputs
  const formElements = refs.eventForm.querySelectorAll('input, textarea, select, button');
  formElements.forEach(el=>{
    // keep the role select and theme toggle enabled; only disable form inputs and form buttons
    if(el === refs.roleSelect || el === refs.themeToggle) return;
    // For buttons inside form only
    if(el.tagName === 'BUTTON' && !refs.eventForm.contains(el)) return;
  });

  // Visual & functional changes
  if(isStudent){
    refs.formCard.classList.add('disabled');
    refs.roleNotice.textContent = 'You are viewing as a STUDENT — events are read-only.';
  } else {
    refs.formCard.classList.remove('disabled');
    refs.roleNotice.textContent = 'You are viewing as a TEACHER — you can add, edit, and delete events.';
  }

  // Enable/disable the actual form fields and action buttons
  const disableFields = isStudent;
  ['title','date','startTime','endTime','description','reminder','clearBtn','saveBtn'].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(disableFields){
      el.setAttribute('disabled','disabled');
    } else {
      el.removeAttribute('disabled');
    }
  });

  // Re-render upcoming list and calendar so buttons (edit/delete) appear/hide
  renderCalendar();
  renderUpcomingList();
}

/* -----------------------
   Calendar rendering
   ----------------------- */
function renderWeekdays(){
  refs.weekdayRow.innerHTML = '';
  for(let i=0;i<7;i++){
    const el = document.createElement('div');
    el.textContent = WEEKDAYS[i];
    refs.weekdayRow.appendChild(el);
  }
}

function renderCalendar(){
  refs.calendarGrid.innerHTML = '';
  const view = state.currentMonth;
  const first = startOfMonth(view);
  const last = endOfMonth(view);
  const startDayIdx = first.getDay();
  const gridStart = new Date(first);
  gridStart.setDate(first.getDate() - startDayIdx);
  const totalCells = 42;
  const monthName = view.toLocaleString(undefined, {month:'long'});
  refs.monthLabel.textContent = monthName;
  refs.yearLabel.textContent = view.getFullYear();
  const todayYMD = ymdFromDate(new Date());

  for(let i=0;i<totalCells;i++){
    const cellDate = new Date(gridStart);
    cellDate.setDate(gridStart.getDate() + i);
    const ymd = ymdFromDate(cellDate);
    const isCurrentMonth = cellDate.getMonth() === view.getMonth();
    const dayEl = document.createElement('div');
    dayEl.className = 'day' + (isCurrentMonth ? '' : ' muted-day');
    dayEl.setAttribute('data-ymd', ymd);
    dayEl.setAttribute('role','gridcell');
    dayEl.setAttribute('aria-label', cellDate.toDateString());

    if(ymd === todayYMD) dayEl.classList.add('today');
    if(state.selectedDate && state.selectedDate === ymd) dayEl.classList.add('selected');

    const num = document.createElement('div');
    num.className = 'date-num';
    num.textContent = pad(cellDate.getDate());

    const dayEvents = state.events.filter(ev => ev.date === ymd);
    if(dayEvents.length){
      const count = document.createElement('div');
      count.className = 'event-count';
      count.textContent = dayEvents.length + (dayEvents.length === 1 ? ' event' : ' events');
      num.appendChild(count);
    }
    dayEl.appendChild(num);

    if(dayEvents.length){
      const mk = document.createElement('div');
      mk.className = 'markers';
      dayEvents.slice(0,3).forEach(ev=>{
        const b = document.createElement('span');
        b.className = 'event-badge';
        const initials = ev.title.split(' ').map(s=>s[0]||'').slice(0,2).join('').toUpperCase();
        b.textContent = initials;
        b.title = ev.title + ' — ' + format12(ymdToDate(ev.date, ev.startTime));
        mk.appendChild(b);
      });
      dayEl.appendChild(mk);
    }

    dayEl.addEventListener('click', ()=>{
      state.selectedDate = ymd;
      refs.dateInput.value = ymd;
      if(!refs.startTimeInput.value){
        const d = new Date();
        d.setMinutes(0,0,0);
        d.setHours(d.getHours() + 1);
        refs.startTimeInput.value = pad(d.getHours()) + ':' + pad(d.getMinutes());
      }
      if(!refs.endTimeInput.value && refs.startTimeInput.value){
        const [hh,mm] = refs.startTimeInput.value.split(':').map(Number);
        const dd = new Date();
        dd.setHours(hh+1, mm, 0, 0);
        refs.endTimeInput.value = pad(dd.getHours()) + ':' + pad(dd.getMinutes());
      }
      renderCalendar();
    });

    refs.calendarGrid.appendChild(dayEl);
  }
}

/* -----------------------
   Event list & CRUD
   ----------------------- */
function getEventsSorted(){ return state.events.slice().sort((a,b)=> ymdToDate(a.date,a.startTime).getTime() - ymdToDate(b.date,b.startTime).getTime()); }

function renderUpcomingList(){
  const now = Date.now();
  const upcoming = getEventsSorted().filter(ev => ymdToDate(ev.date, ev.endTime).getTime() >= now);
  refs.upcomingList.innerHTML = '';
  if(upcoming.length === 0){
    const p = document.createElement('div');
    p.className = 'muted small';
    p.textContent = 'No upcoming events.';
    refs.upcomingList.appendChild(p);
    return;
  }

  upcoming.forEach(ev=>{
    const item = document.createElement('div');
    item.className = 'event-item';

    const left = document.createElement('div');
    left.style.width = '64px';
    left.style.display = 'flex';
    left.style.flexDirection = 'column';
    left.style.gap = '6px';
    left.style.alignItems = 'flex-start';

    const time = document.createElement('div');
    time.className = 'event-time';
    time.textContent = format12(ymdToDate(ev.date, ev.startTime));
    left.appendChild(time);

    const meta = document.createElement('div');
    meta.className = 'event-meta';
    const title = document.createElement('div');
    title.className = 'event-title';
    title.textContent = ev.title;
    const when = document.createElement('small');
    when.className = 'muted small';
    const d = new Date(ev.date + 'T00:00:00');
    when.textContent = d.toLocaleDateString(undefined, {weekday:'short', month:'short', day:'numeric'});
    const desc = document.createElement('div');
    desc.className = 'event-desc';
    desc.textContent = ev.description || '';
    // createdBy tag
    const creatorTag = document.createElement('span');
    creatorTag.className = 'tag';
    creatorTag.textContent = ev.createdBy ? `By: ${ev.createdBy}` : 'By: unknown';

    meta.appendChild(title);
    meta.appendChild(when);
    meta.appendChild(desc);
    meta.appendChild(creatorTag);

    const actions = document.createElement('div');
    actions.style.marginLeft = 'auto';
    actions.style.display = 'flex';
    actions.style.flexDirection = 'column';
    actions.style.alignItems = 'flex-end';
    actions.style.gap = '6px';

    // Edit & Delete only visible to teacher role
    if(state.role === 'teacher'){
      const editBtn = document.createElement('button');
      editBtn.className = 'btn';
      editBtn.textContent = 'Edit';
      editBtn.addEventListener('click', ()=>{
        populateFormForEdit(ev.id);
        window.scrollTo({top:0,behavior:'smooth'});
      });

      const delBtn = document.createElement('button');
      delBtn.className = 'btn ghost';
      delBtn.textContent = 'Delete';
      delBtn.addEventListener('click', ()=>{
        if(confirm('Delete this event?')) { deleteEvent(ev.id); }
      });

      actions.appendChild(editBtn);
      actions.appendChild(delBtn);
    } else {
      const viewNote = document.createElement('div');
      viewNote.className = 'muted small';
      viewNote.textContent = 'Read-only';
      actions.appendChild(viewNote);
    }

    item.appendChild(left);
    item.appendChild(meta);
    item.appendChild(actions);

    refs.upcomingList.appendChild(item);
  });
}

function addOrUpdateEvent(ev){
  if(ev.id){
    const idx = state.events.findIndex(x=>x.id === ev.id);
    if(idx !== -1) state.events[idx] = ev;
  } else {
    ev.id = Date.now().toString(36) + Math.random().toString(36).slice(2,7);
    state.events.push(ev);
  }
  saveEvents(state.events);
  renderCalendar();
  renderUpcomingList();
  checkNotificationsOnce();
}

function deleteEvent(id){
  state.events = state.events.filter(e => e.id !== id);
  saveEvents(state.events);
  renderCalendar();
  renderUpcomingList();
  state.notified = state.notified.filter(x=>x !== id);
  saveNotified(state.notified);
}

function populateFormForEdit(id){
  const ev = state.events.find(e => e.id === id);
  if(!ev) return;
  refs.eventIdInput.value = ev.id;
  refs.titleInput.value = ev.title;
  refs.dateInput.value = ev.date;
  refs.startTimeInput.value = ev.startTime;
  refs.endTimeInput.value = ev.endTime;
  refs.descInput.value = ev.description || '';
  if(ev.reminderMins !== undefined) refs.reminderSelect.value = String(ev.reminderMins);
}

/* -----------------------
   Form handling & validation
   ----------------------- */
refs.eventForm.addEventListener('submit', (e)=>{
  e.preventDefault();
  if(state.role !== 'teacher'){
    alert('Only teachers can create or edit events.');
    return;
  }

  const title = refs.titleInput.value.trim();
  const date = refs.dateInput.value;
  const start = refs.startTimeInput.value;
  const end = refs.endTimeInput.value;

  if(!title || !date || !start || !end){
    alert('Please complete required fields: title, date, start and end times.');
    return;
  }

  const startDt = ymdToDate(date, start);
  const endDt = ymdToDate(date, end);
  if(endDt <= startDt){
    alert('End time must be after start time.');
    return;
  }

  const eventObj = {
    id: refs.eventIdInput.value || null,
    title,
    date,
    startTime: start,
    endTime: end,
    description: refs.descInput.value.trim(),
    reminderMins: Number(refs.reminderSelect.value),
    createdBy: state.role // teacher or student (teacher in this case)
  };

  addOrUpdateEvent(eventObj);
  clearForm();
});

function clearForm(){
  refs.eventIdInput.value = '';
  refs.titleInput.value = '';
  refs.dateInput.value = '';
  refs.startTimeInput.value = '';
  refs.endTimeInput.value = '';
  refs.descInput.value = '';
  refs.reminderSelect.value = '10';
  state.selectedDate = null;
  renderCalendar();
}

/* -----------------------
   Navigation controls
   ----------------------- */
refs.todayBtn.addEventListener('click', ()=>{ state.currentMonth = new Date(); renderCalendar(); });
refs.prevMonthBtn.addEventListener('click', ()=>{ state.currentMonth = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth() - 1, 1); renderCalendar(); });
refs.nextMonthBtn.addEventListener('click', ()=>{ state.currentMonth = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth() + 1, 1); renderCalendar(); });

/* -----------------------
   Notifications (silent toasts)
   ----------------------- */
function createToast(ev){
  const toast = document.createElement('div');
  toast.className = 'toast';
  const left = document.createElement('div');
  left.className = 'left';
  left.textContent = ev.title.split(' ').map(s=>s[0]||'').slice(0,2).join('').toUpperCase();
  const right = document.createElement('div');
  right.className = 'right';
  const t = document.createElement('div'); t.className = 'title'; t.textContent = ev.title;
  const when = document.createElement('small');
  const dt = ymdToDate(ev.date, ev.startTime);
  when.textContent = `${dt.toLocaleDateString(undefined, {month:'short', day:'numeric'})} • ${format12(dt)}`;
  const desc = document.createElement('div'); desc.className = 'muted small'; desc.textContent = ev.description || '';

  const closeBtn = document.createElement('button'); closeBtn.className = 'close'; closeBtn.title = 'Close'; closeBtn.innerHTML = '&#10005;';
  closeBtn.addEventListener('click', ()=>{ hideToast(toast); });

  right.appendChild(t);
  right.appendChild(when);
  if(ev.description) right.appendChild(desc);

  const topRow = document.createElement('div');
  topRow.style.display = 'flex';
  topRow.style.alignItems = 'center';
  topRow.style.gap = '8px';
  topRow.appendChild(left);
  topRow.appendChild(right);

  toast.appendChild(topRow);
  toast.appendChild(closeBtn);
  refs.notificationsContainer.appendChild(toast);

  requestAnimationFrame(()=>{ toast.classList.add('show'); });

  const auto = setTimeout(()=>{ hideToast(toast); }, 5000);
  function hideToast(el){
    el.classList.remove('show');
    setTimeout(()=>{ if(el && el.parentNode) el.parentNode.removeChild(el); }, 300);
    clearTimeout(auto);
  }
}

function checkNotificationsOnce(){
  const now = Date.now();
  const events = getEventsSorted();
  events.forEach(ev=>{
    const reminder = (ev.reminderMins !== undefined) ? Number(ev.reminderMins) : 10;
    const evStart = ymdToDate(ev.date, ev.startTime).getTime();
    const notifyAt = evStart - (reminder * 60000);
    if(notifyAt <= now && evStart >= now && !state.notified.includes(ev.id)){
      createToast(ev);
      state.notified.push(ev.id);
      saveNotified(state.notified);
    }
  });

  // cleanup notified set (keep IDs for recent events only)
  const stillRelevant = [];
  state.notified.forEach(id=>{
    const ev = state.events.find(e=>e.id===id);
    if(!ev) return;
    const evEnd = ymdToDate(ev.date, ev.endTime).getTime();
    if(evEnd > now - (60*1000*60*24)) stillRelevant.push(id);
  });
  state.notified = stillRelevant;
  saveNotified(state.notified);
}

let checkInterval = null;
function startNotificationLoop(){
  checkNotificationsOnce();
  if(checkInterval) clearInterval(checkInterval);
  checkInterval = setInterval(checkNotificationsOnce, 60*1000);
}

/* -----------------------
   UI wiring: role + theme selectors
   ----------------------- */
refs.roleSelect.addEventListener('change', (e)=> applyRole(e.target.value) );
refs.themeToggle.addEventListener('click', ()=>{
  const newTheme = state.theme === 'dark' ? 'light' : 'dark';
  applyTheme(newTheme);
});

/* -----------------------
   Initialization
   ----------------------- */
function init(){
  // Render static pieces
  renderWeekdays();
  renderCalendar();
  renderUpcomingList();

  // set default date & times
  const now = new Date();
  refs.dateInput.value = ymdFromDate(now);
  const startD = new Date();
  startD.setMinutes(0,0,0);
  startD.setHours(startD.getHours()+1);
  const endD = new Date(startD);
  endD.setHours(endD.getHours()+1);
  refs.startTimeInput.value = pad(startD.getHours()) + ':' + pad(startD.getMinutes());
  refs.endTimeInput.value = pad(endD.getHours()) + ':' + pad(endD.getMinutes());

  // apply saved theme & role
  applyTheme(state.theme);
  applyRole(state.role);

  // listen to storage events (sync across tabs)
  window.addEventListener('storage', (e)=>{
    if(e.key === STORAGE_KEY){ state.events = loadEvents(); renderCalendar(); renderUpcomingList(); }
    if(e.key === NOTIFIED_KEY){ state.notified = loadNotified(); }
    if(e.key === ROLE_KEY){ state.role = loadRole(); applyRole(state.role); }
    if(e.key === THEME_KEY){ state.theme = loadTheme(); applyTheme(state.theme); }
  });

  // start notification loop
  startNotificationLoop();
}

/* -----------------------
   Expose some helpers for debugging
   ----------------------- */
window.ScheduleMaster = {
  state,
  addEvent: (ev)=>{ addOrUpdateEvent(ev); },
  deleteEvent,
  renderCalendar,
  renderUpcomingList
};

/* -----------------------
   Start app
   ----------------------- */
init();

</script>
</body>
</html>
